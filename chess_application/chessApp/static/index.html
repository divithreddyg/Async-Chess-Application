<html>

<head>
<meta charset="UTF-8"> 
<title>Chess</title>

<style type="text/css">

.chessboard {
    width: 560px;
    height: 560px;
    margin: auto;
    border: 1px solid black;
}
.black {
    float: left;
    width: 70px;
    height: 70px;
    background-color: #975c29;
    font-size:50px;
    text-align:center;
    display: table-cell;
    vertical-align:middle;
}
.white {
    float: left;
    width: 70px;
    height: 70px;
    background-color: #fff;
    font-size:50px;
    text-align:center;
    display: table-cell;
    vertical-align:middle;
}

.black-clicked {
    float: left;
    width: 60px;
    height: 60px;
    background-color: #975c29;
    font-size:44px;
    text-align:center;
    display: table-cell;
    vertical-align:middle;
    font-weight: bold;
    border: 5px solid black;
}
.white-clicked {
    float: left;
    width: 60px;
    height: 60px;
    background-color: #fff;
    font-size:44px;
    text-align:center;
    display: table-cell;
    vertical-align:middle;
    font-weight: bold;
    border: 5px solid black;
}


.center {
  margin: auto;
  width: 60%;
  padding: 10px;
}

</style>

</head>

<body>
    <div id="newGame" class="center" >
        <input type="button" value="New Game" onclick="startNewGame();">
    </div>
    <div id="DisplayTop" class="center" >

    </div>
    <div class="chessboard">
    <!-- 1st -->
    <div id = "0-0" class="white" onclick="makeMove(id);">&#9820;</div>
    <div id = "0-1" class="black" onclick="makeMove(id);">&#9822;</div>
    <div id = "0-2" class="white" onclick="makeMove(id);">&#9821;</div>
    <div id = "0-3" class="black" onclick="makeMove(id);">&#9819;</div>
    <div id = "0-4" class="white" onclick="makeMove(id);">&#9818;</div>
    <div id = "0-5" class="black" onclick="makeMove(id);">&#9821;</div>
    <div id = "0-6" class="white" onclick="makeMove(id);">&#9822;</div>
    <div id = "0-7" class="black" onclick="makeMove(id);">&#9820;</div>
    <!-- 2nd -->
    <div id = "1-0" class="black" onclick="makeMove(id);">&#9823;</div>
    <div id = "1-1" class="white" onclick="makeMove(id);">&#9823;</div>
    <div id = "1-2" class="black" onclick="makeMove(id);">&#9823;</div>
    <div id = "1-3"class="white" onclick="makeMove(id);">&#9823;</div>
    <div id = "1-4" class="black" onclick="makeMove(id);">&#9823;</div>
    <div id = "1-5" class="white" onclick="makeMove(id);">&#9823;</div>
    <div id = "1-6" class="black" onclick="makeMove(id);">&#9823;</div>
    <div id = "1-7" class="white" onclick="makeMove(id);">&#9823;</div>
    <!-- 3rd -->
    <div id = "2-0" class="white" onclick="makeMove(id);"></div>
    <div id = "2-1" class="black" onclick="makeMove(id);"></div>
    <div id = "2-2" class="white" onclick="makeMove(id);"></div>
    <div id = "2-3" class="black" onclick="makeMove(id);"></div>
    <div id = "2-4" class="white" onclick="makeMove(id);"></div>
    <div id = "2-5" class="black" onclick="makeMove(id);"></div>
    <div id = "2-6" class="white" onclick="makeMove(id);"></div>
    <div id = "2-7" class="black" onclick="makeMove(id);"></div>
    <!-- 4th -->
    <div id = "3-0" class="black" onclick="makeMove(id);"></div>
    <div id = "3-1" class="white" onclick="makeMove(id);"></div>
    <div id = "3-2" class="black" onclick="makeMove(id);"></div>
    <div id = "3-3" class="white" onclick="makeMove(id);"></div>
    <div id = "3-4" class="black" onclick="makeMove(id);"></div>
    <div id = "3-5" class="white" onclick="makeMove(id);"></div>
    <div id = "3-6" class="black" onclick="makeMove(id);"></div>
    <div id = "3-7" class="white" onclick="makeMove(id);"></div>
    <!-- 5th -->
    <div id = "4-0" class="white" onclick="makeMove(id);"></div>
    <div id = "4-1" class="black" onclick="makeMove(id);"></div>
    <div id = "4-2" class="white" onclick="makeMove(id);"></div>
    <div id = "4-3" class="black" onclick="makeMove(id);"></div>
    <div id = "4-4" class="white" onclick="makeMove(id);"></div>
    <div id = "4-5" class="black" onclick="makeMove(id);"></div>
    <div id = "4-6" class="white" onclick="makeMove(id);"></div>
    <div id = "4-7" class="black" onclick="makeMove(id);"></div>
    <!-- 6th -->
    <div id = "5-0" class="black" onclick="makeMove(id);"></div>
    <div id = "5-1" class="white" onclick="makeMove(id);"></div>
    <div id = "5-2" class="black" onclick="makeMove(id);"></div>
    <div id = "5-3" class="white" onclick="makeMove(id);"></div>
    <div id = "5-4" class="black" onclick="makeMove(id);"></div>
    <div id = "5-5" class="white" onclick="makeMove(id);"></div>
    <div id = "5-6" class="black" onclick="makeMove(id);"></div>
    <div id = "5-7" class="white" onclick="makeMove(id);"></div>
    <!-- 7th -->
    <div id = "6-0" class="white" onclick="makeMove(id);">&#9817;</div>
    <div id = "6-1" class="black" onclick="makeMove(id);">&#9817;</div>
    <div id = "6-2" class="white" onclick="makeMove(id);">&#9817;</div>
    <div id = "6-3" class="black" onclick="makeMove(id);">&#9817;</div>
    <div id = "6-4" class="white" onclick="makeMove(id);">&#9817;</div>
    <div id = "6-5" class="black" onclick="makeMove(id);">&#9817;</div>
    <div id = "6-6" class="white" onclick="makeMove(id);">&#9817;</div>
    <div id = "6-7" class="black" onclick="makeMove(id);">&#9817;</div>
    <!-- 8th -->
    <div id = "7-0" class="black" onclick="makeMove(id);">&#9814;</div>
    <div id = "7-1" class="white" onclick="makeMove(id);">&#9816;</div>
    <div id = "7-2" class="black" onclick="makeMove(id);">&#9815;</div>
    <div id = "7-3" class="white" onclick="makeMove(id);">&#9813;</div>
    <div id = "7-4" class="black" onclick="makeMove(id);">&#9812;</div>
    <div id = "7-5" class="white" onclick="makeMove(id);">&#9815;</div>
    <div id = "7-6" class="black" onclick="makeMove(id);">&#9816;</div>
    <div id = "7-7" class="white" onclick="makeMove(id);">&#9814;</div>
    </div>
</body>
<script type="text/javascript">
    let black_pieces = [document.getElementById("0-0").innerHTML, document.getElementById("0-1").innerHTML, document.getElementById("0-2").innerHTML, document.getElementById("0-3").innerHTML, document.getElementById("0-4").innerHTML, document.getElementById("1-0").innerHTML];
    let white_pieces = [document.getElementById("7-0").innerHTML, document.getElementById("7-1").innerHTML, document.getElementById("7-2").innerHTML, document.getElementById("7-3").innerHTML, document.getElementById("7-4").innerHTML, document.getElementById("6-0").innerHTML];
    let clicked = null;
    let game_started = false;
    let turn = false;
    function makeMove(id) {
        if (game_started == false && turn == false) {
            alert("Game has not started yet!");
            return;
        }
        if (clicked == null) {
            clicked = id;
            let element = document.getElementById(id);
            if (element.className == "white") {
                element.className = "white-clicked";
            } else if (element.className == "black") {
                element.className = "black-clicked";
            }

        } else {
            // destination
            if (id != clicked) {
                let source = document.getElementById(clicked);
                let destination = document.getElementById(id);

                if (source.className == "white-clicked") {
                    source.className = "white";
                } else if (source.className == "black-clicked") {
                    source.className = "black";
                }

                url = window.location.href;
                console.log(url);

                request = new XMLHttpRequest();
                request.open('GET', '/makeMove?source=' + clicked + '&destination=' + id);
                request.send();
                request.onload = () => {
                    console.log(request);
                    if (request.status == 200) {
                        console.log("success");
                        destination.innerHTML = source.innerHTML;
                        source.innerHTML = "";
                        clicked = null;
                        turn = false;
                        let response = JSON.parse(request.responseText);
                        console.log(response);
                        parse_board(response.encoded_game_state);
                        get_move();
                    } else {
                        clicked = null;
                        console.log("failure");
                    }
                }
                
            }
        }
    }

    function parse_board(game_state) {
       let row = 0;
       let col = 0;
       for (let index = 0; index < 64; index++) {
            let element;
            switch (game_state[index]) {
                case("."):
                    element = "";
                    break;
                case("K"):
                    element = white_pieces[4];
                    break;
                case("Q"):
                    element = white_pieces[3];
                    break;
                case("B"):
                    element = white_pieces[2];
                    break;
                case("N"):
                    element = white_pieces[1];
                    break;
                case("R"):
                    element = white_pieces[0];
                    break;
                case("P"):
                    element = white_pieces[5];
                    break;
                case("k"):
                    element = black_pieces[4];
                    break;
                case("q"):
                    element = black_pieces[3];
                    break;
                case("b"):
                    element = black_pieces[2];
                    break;
                case("n"):
                    element = black_pieces[1];
                    break;
                case("r"):
                    element = black_pieces[0];
                    break;
                case("p"):
                    element = black_pieces[5];
                    break;
            }
            document.getElementById(row+"-"+col).innerHTML = element;
            col += 1;
            if (col == 8) {
                col = 0;
                row += 1;
           }
        }

    }

    function get_move() {
        document.getElementById("DisplayTop").innerHTML = "Waiting for opponent to move...";
        url = window.location.href;
        console.log(url);
        request = new XMLHttpRequest();
        request.open('GET', '/getMove');
        request.send();
        request.onload = () => {
            console.log(request);
            if (request.status == 200) {
                console.log("success");
                let response = JSON.parse(request.responseText);
                console.log(response);
                <!-- parse the board -- >
                turn = true;
                document.getElementById("DisplayTop").innerHTML = "It's your turn";
                let board = JSON.parse(request.responseText).encoded_game_state;
                parse_board(board);
            } else {
                console.log("failure");
            }
        }
    }

    let color = "";
    function startNewGame() {
        url = window.location.href;
        console.log(url);
        request = new XMLHttpRequest();
        request.open('GET', '/startNewGame');
        request.send();
        
        document.getElementById("newGame").style.display = "none";
        document.getElementById("DisplayTop").innerHTML = "Searching for players";
        request.onload = () => {
            console.log(request);
            if (request.status == 200) {
                console.log("success");
                game_started = true;
                color = JSON.parse(request.responseText).color;
                console.log(color);
                if (color.includes("White")) {
                    document.getElementById("DisplayTop").innerHTML = "Game started - You are white. Its your turn";
                    turn = true;
                } else {
                    document.getElementById("DisplayTop").innerHTML = "Game started - You are black. Waiting for opponent to move";
                    turn = false;
                    get_move();
                }

            } else {
                console.log("failure");
                document.getElementById("newGame").style.display = "block";
                document.getElementById("DisplayTop").innerHTML = "Could not find any opponents";
            }
        }
    }
</script>
</html>